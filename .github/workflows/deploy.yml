name: Deploy Hugo Site to S3

# 1. 언제 실행할 것인가?
on:
  push:
    branches:
      - main

jobs:
  Deploy: # (YAML 파일은 2칸 들여쓰기가 규칙입니다)
    name: Build and Deploy
    # 2. 어디서 실행할 것인가?
    runs-on: ubuntu-latest # Linux 가상 머신에서 실행

    steps:
      # 3. 무엇을 할 것인가? (순서대로)
      
      # 1단계: Git 리포지토리의 코드를 가상 머신으로 내려받기
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true # Hugo 테마가 submodule일 경우 포함

      # 2단계: Hugo 설치하기
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest' # 최신버전 Hugo 사용

      # 3단계: Hugo 빌드 실행 (수동으로 'Hugo' 명령어 친 것과 동일)
      - name: Build
        run: hugo --minify

      # 4단계: AWS 인증 (GitHub Secrets에 등록한 키 사용)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # S3 버킷(hyosup17-dev)이 있는 리전을 정확히 적어주세요.
          aws-region: ap-northeast-2

      # 5단계: S3에 빌드된 파일 업로드 (수동으로 'aws s3 sync' 한 것과 동일)
      - name: Deploy to S3
        run: |
          aws s3 sync public/ s3://my-hugo-blog-for-terraform-test --delete

      # 6단계: CloudFront 캐시 삭제 (필수)
      # S3 파일이 바뀌어도 CloudFront는 옛날 파일을 기억하고 있다.
      # "파일이 바뀌었으니 캐시를 지워야함"이라고 알려줘야한다.
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation --distribution-id EJX5CXJZMLAKM --paths "/*"